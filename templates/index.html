<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="referrer" content="no-referrer" />
    <meta name="theme-color" content="#ffffff" />
    <title>Data Migration Tool</title>
    <link rel="stylesheet" href="/static/style.css?v=1.0" />
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
  </head>
  <body>
    <h1>üîÑ Data Migration Tool</h1>

    <form id="migrationForm">
      <!-- API Destination -->
      <label for="short_api_url">API Destination URL:</label>
      <input
        type="text"
        id="short_api_url"
        name="short_api_url"
        value=""
        style="width: 600px; height: 40px"
      />

      <!-- Login Email -->
      <label for="email">Login Email:</label>
      <input
        type="email"
        id="email"
        name="email"
        value=""
        style="width: 600px; height: 40px"
      />

      <!-- Password -->
      <label for="password">Password:</label>
      <input
        type="password"
        id="password"
        name="password"
        value=""
        style="width: 600px; height: 40px"
      />

      <!-- Adapter Selection -->
      <label for="adapter_name">Adapter Name:</label>
      <select id="adapter_name" name="adapter_name" required>
        {% for name in adapter_names %}
        <option value="{{ name }}" {% if loop.first %}selected{% endif %}>
          {{ name }}
        </option>
        {% endfor %}
      </select>

      <!-- Entity Selection -->
      <label for="entity">Entity:</label>
      <select id="entity" name="entity" required>
        <!-- <option value="action">Action</option> -->
        <option value="classifications">Classifications</option>
        <!-- <option value="documents">Documents</option> -->
        <!-- <option value="event">Event</option> -->
        <option value="eventUserRelationshipUpdate">
          Event User Relationship
        </option>
        <option value="membershipUserTeam">membershipUserTeam</option>
        <!-- <option value="organisation">Organisation</option> -->
        <option value="project">Project</option>
        <!-- <option value="property">Property</option> -->
        <!-- <option value="stakeholder">Stakeholder</option> -->
        <option value="teamProjectRelationship">
          Team Project Relationship
        </option>
        <option value="teamProjectUnrelate">Team Project Unrelate</option>
        <option value="teams">Teams</option>
        <option value="users">Users</option>
        <option value="users_teams_role">Teams Users Role</option>
        <option value="users_teams_unrelate">Teams Users Unrelate</option>
      </select>

      <!-- Migration Type -->
      <div style="display: flex; align-items: center; gap: 20px; margin: 1em 0">
        <label style="font-weight: bold">Migration Type:</label>
        <label
          ><input
            type="radio"
            name="migration_type"
            value="insert"
            checked
            required
          />
          Insert</label
        >
        <label
          ><input type="radio" name="migration_type" value="update" />
          Update</label
        >
        <label
          ><input type="radio" name="migration_type" value="upsert" />
          Upsert</label
        >
      </div>

      <!-- Input File -->
      <div style="margin: 1em 0">
        <label
          for="input_file"
          style="display: block; font-weight: bold; margin-bottom: 0.5em"
        >
          üìÅ Select Input File:
        </label>
        <input
          type="file"
          id="input_file"
          name="input_file"
          required
          style="padding: 8px; font-size: 16px; width: 600px"
        />
      </div>

      <!-- Migration Settings -->
      <fieldset>
        <legend>Migration Settings</legend>
        <label
          ><input type="checkbox" name="purge_existing" /> Purge existing data
          before migration</label
        >
      </fieldset>

      <!-- Debug Toggle -->
      <label
        ><input type="checkbox" id="show-debug" checked /> Show debug
        logs</label
      >
      <div
        id="debug-output"
        style="
          display: none;
          white-space: pre-wrap;
          font-family: monospace;
          margin-top: 1em;
        "
      ></div>

      <!-- Run Button -->
      <button type="submit" class="run-button">Run Migration</button>
    </form>

    <div id="results" style="margin-top: 30px"></div>

    <script>
      // Auto-correct API URL on blur
      document
        .getElementById("short_api_url")
        .addEventListener("blur", function () {
          let input = this.value.trim();

          // Ensure it starts with https://
          if (!input.startsWith("https://")) {
            input = "https://" + input;
          }

          this.value = input;
        });

      // Toggle debug output
      document
        .getElementById("show-debug")
        .addEventListener("change", function () {
          document.getElementById("debug-output").style.display = this.checked
            ? "block"
            : "none";
        });

      // Handle form submission
      document
        .getElementById("migrationForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(e.target);
          const resultsDiv = document.getElementById("results");
          const debugDiv = document.getElementById("debug-output");
          resultsDiv.innerHTML = "‚è≥ Running migration...";
          debugDiv.textContent = "";

          try {
            const response = await fetch("/run_migration", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (result.status === "success") {
              const summary = result.summary;
              const reports = result.report_paths;
              resultsDiv.innerHTML = `
              <h3>‚úÖ Migration Complete</h3>
              <p><strong>Total Rows:</strong> ${summary.total}</p>
              <p><strong>Successfully Written:</strong> ${summary.success}</p>
              <p><strong>Skipped:</strong> ${summary.skipped}</p>
              <p><strong>Duration:</strong> ${summary.duration} seconds</p>
              ${
                summary.errors.length > 0
                  ? `<details><summary>Skipped Reasons</summary><ul>${summary.errors
                      .map((e) => `<li>${e}</li>`)
                      .join("")}</ul></details>`
                  : ""
              }
              <p><a href="${
                reports.xlsx
              }" download>üì• Download XLSX Report</a></p>
              <p><a href="${
                reports.pdf
              }" download>üì• Download PDF Report</a></p>
              <p><a href="${reports.csv}" download>üì• Download CSV Log</a></p>
            `;

              if (
                document.getElementById("show-debug").checked &&
                result.debug
              ) {
                debugDiv.textContent = result.debug.join("\n");
                debugDiv.scrollIntoView({ behavior: "smooth" });
              }
            } else {
              resultsDiv.innerHTML = `<h3>‚ùå Error</h3><p>${result.message}</p>`;
              if (result.debug) {
                debugDiv.textContent = result.debug.join("\n");
                debugDiv.scrollIntoView({ behavior: "smooth" });
              }
            }
          } catch (err) {
            resultsDiv.innerHTML = `<h3>‚ùå Unexpected Error</h3><p>${err.message}</p>`;
          }
        });
    </script>
  </body>
</html>
